概念

Kubernetes调度Pod到Kubernetes节点上，节点上的Kubelet运行Pod的容器。如果容器内进程终止运行（容器的主进程崩溃），Kubelet会自动重启容器，这体现了Kubernetes赋予应用的自愈能力。在某些情况下，即使容器内进程没有崩溃，应用程序仍不能正常工作。Kubernetes默认只是检查Pod的容器是否正常运行，但容器正常运行并不一定代表应用健康。我们可以通过Kubernetes提供的探针来探测容器应用是否健康，然后决定是否重启恢复应用到正常工作状态，以及决定容器是否能接收请求。

Kubernetes探针有两种类型：

存活探针（Liveness Probe）：探测容器内应用程序是否健康。若不健康，意味探测失败，Kubemetes将定期执行探针并重新启动容器。
就绪探针（Readiness Probe）：探测容器是否已经就绪。只有当Pod内所有容器都处于就绪状态时kubelet才会认定该Pod处于就绪状态。若不健康，意味探测失败，Pod将会被Kubernetes从相应的Endpoint list中移除，请求不再分发到该Pod的容器上。特别是在容器创建后，应用程序需要进行初始化或加载数据，可能是几秒或者更长时间，这段时间里不能对外提供服务，因此不应该将请求分发到该Pod上。
Kubernetes支持三种探测方式：

EXEC：在容器中执行一个命令，如果命令退出码返回 0 则表示探测成功，否则表示失败。
TCP：对指定的容IP及端口执行一个TCP检查，如果端口是开放的则表示探测成功，否则表示失败。
HTTPGet：对指定的容器IP、端口及路径执行一个HTTP Get请求，如果返回的状态码在 [200, 399] 之间则表示探测成功，否则表示失败。
配置探针

EXEC探测

通过在目标容器中执行由用户自定义的命令来判断容器的监控状态，若命令状态返回值为 0 则表示“成功”通过检测，其他值则均为“失败”状态。执行命令例如/bin/sh -c echo liveness-http test > /usr/share/nginx/html/health

HTTPGet探测

基于HTTP的探测（HTTPGetAction）向目标容器发起一个HTTP请求，根据请求响应码进行结果判定，响应码如2xx或3xx时表示探测成功。

请求协议（scheme）：默认是HTTP，还可指定HTTPS
访问路径（path）：请求URL里除服务地址（或域名）和端口外的部分，例如 /health_check。
容器端口（port）：访问的容器的端口名字或者端口号，例如 80、8080等。端口号必须介于1 ~ 65525之间。
请求头（httpHeaders）：自定义请求的header，例如 X-Custom-Header=Awsome，多个header使用分号分隔（限于在PSET上填写的方式）。
TCP探测

Kubelet将尝试在指定端口上打开容器的套接字。 如果可以建立连接，容器被认为是健康的，如果不能就认为是失败的。容器端口与HTTPGet里的容器端口一样。

探针其他配置项

探针还有其他配置项，以便更加精确地控制探针。

探测开始前等待时间（initialDelaySeconds）：容器启动后第一次执行探测需要等待的时间。
探测间隔时间（periodSeconds）：执行探测的频率。默认是 10 秒，最小 1 秒。
探测超时时间（timeoutSeconds）：探测超时时间，探测未在改时间内完成将被视为失败。默认 3 秒，最小 1 秒。
最少连续成功次数（successThreshold）：探测失败后，最少连续探测成功多少次才被认定为成功。默认是 3，最小值是 1。注意：对于存活探针，此项必须是 1。
最少连续失败次数（failureThreshold）：探测成功后，最少连续探测失败多少次才被认定为失败。默认是 3，最小值是 1。
注：PSET上的配置项默认值与Kubernetes默认值略有区别。

注意事项

错误使用探针会对程序运行造成坏的影响，可能让应用变得不可靠。

探测开始前等待时间必须要合理，时间过短容器内程序启动未完成，可能让探测失败。在配置存活探针的情况下，容器可能会不断被重启。时间过长，探针没有及时检测到容器的状态，影响下一步操作。
探测间隔时间是两次相邻探测之间的间隔时间，时间过短，探测频率高，增加了Kubelet执行压力以及容器处理请求或执行命令的压力。时间过长，探针不能及时检测到容器状态，影响下一步操作。
探测超时时间对EXEC探测方式无效，Kubelet不会终止执行命令，若要让执行命令超时后退出，容器需要自行处理。
对HTTPGet探测方式，访问路径对应的接口最好是不要处理业务的，而是专门判断服务是否正常，处理业务失败并不意味应用发生了异常。可单独写一个接口比如/health_check。该接口不处理任何业务逻辑，并能够很快响应请求。
